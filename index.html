<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kasir</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: #f0f2f5;
            color: #333;
            height: 100dvh;
            overflow: hidden;
        }

        .container {
            display: flex;
            flex-direction: column;
            height: 100%;
            max-width: 600px;
            margin: 0 auto;
            background-color: #ffffff;
        }

        header {
            background-color: #007bff;
            color: white;
            padding: 12px 15px;
            font-size: 1.1rem;
            font-weight: 600;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            flex-shrink: 0;
            z-index: 10;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .search-filter-container {
            padding: 10px 15px;
            background-color: #fff;
            border-bottom: 1px solid #ddd;
            flex-shrink: 0;
            position: sticky;
            top: 0;
            z-index: 9;
        }

        #search-bar {
            width: 100%;
            padding: 12px;
            font-size: 1rem;
            border: 1px solid #ccc;
            border-radius: 8px;
        }

        .category-filter {
            display: flex;
            overflow-x: auto;
            padding: 10px 0 5px 0;
            white-space: nowrap;
        }

        .category-filter::-webkit-scrollbar {
            height: 5px;
        }

        .category-filter::-webkit-scrollbar-thumb {
            background: #ccc;
            border-radius: 10px;
        }

        .category-filter button {
            padding: 8px 15px;
            margin-right: 8px;
            border: 1px solid #007bff;
            background-color: #fff;
            color: #007bff;
            border-radius: 20px;
            font-size: 0.85rem;
            cursor: pointer;
            flex-shrink: 0;
        }

        .category-filter button.active {
            background-color: #007bff;
            color: #fff;
            font-weight: 600;
        }

        main {
            flex-grow: 1;
            overflow-y: auto;
            padding: 10px 15px;
            background-color: #f9f9f9;
        }

        #product-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 12px;
        }

        .product-item {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 10px;
            text-align: center;
            background-color: #fff;
            cursor: pointer;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s, box-shadow 0.2s;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .product-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .product-item h4 {
            margin: 5px 0;
            font-size: 0.85rem;
            color: #333;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
            min-height: 2.5em;
        }

        .product-item p {
            margin: 0;
            font-size: 0.9rem;
            color: #0056b3;
            font-weight: 600;
        }

        .product-item .stock {
            font-size: 0.75rem;
            color: #666;
        }

        #product-not-found {
            display: none;
            text-align: center;
            padding: 30px;
            color: #888;
        }

        footer {
            flex-shrink: 0;
            border-top: 1px solid #ccc;
            background-color: #fff;
            padding: 15px;
            box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.08);
            z-index: 10;
        }

        .cart-summary {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .cart-summary .total-items {
            font-size: 0.9rem;
            color: #555;
        }

        .cart-summary .total-price {
            font-size: 1.2rem;
            font-weight: 700;
            color: #007bff;
        }

        .footer-actions {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 10px;
            margin-top: 10px;
        }

        #checkout-button {
            padding: 15px;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
        }

        #checkout-button:disabled {
            background-color: #aaa;
            cursor: not-allowed;
        }

        #reset-cart-button {
            padding: 15px;
            background-color: #fff;
            color: #dc3545;
            border: 1px solid #dc3545;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
        }

        #reset-cart-button:disabled {
            background-color: #f4f4f4;
            color: #aaa;
            border-color: #ccc;
            cursor: not-allowed;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: #fff;
            padding: 20px;
            border-radius: 12px;
            width: 90%;
            max-width: 400px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
        }

        .modal-content h3 {
            margin-bottom: 15px;
            text-align: center;
            color: #333;
        }

        #modal-cart-list {
            list-style: none;
            overflow-y: auto;
            flex-grow: 1;
            border-top: 1px solid #eee;
            border-bottom: 1px solid #eee;
        }

        #modal-cart-list li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 5px;
            border-bottom: 1px solid #f4f4f4;
        }

        #modal-cart-list .item-name {
            font-size: 0.9rem;
            flex: 2.5;
            margin-right: 5px;
            line-height: 1.3;
        }

        #modal-cart-list .item-qty-controls {
            flex: 1.5;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 1rem;
            font-weight: 600;
        }

        .modal-qty-btn {
            background-color: #f0f2f5;
            border: none;
            border-radius: 50%;
            font-weight: bold;
            color: #007bff;
            width: 28px;
            height: 28px;
            font-size: 1.2rem;
            line-height: 28px;
            text-align: center;
            cursor: pointer;
        }

        .modal-qty-btn:disabled {
            color: #aaa;
            background-color: #f9f9f9;
            cursor: not-allowed;
        }

        #modal-cart-list .item-total {
            font-size: 0.95rem;
            font-weight: 600;
            flex: 1.5;
            text-align: right;
        }

        .modal-total {
            display: flex;
            justify-content: space-between;
            font-size: 1.2rem;
            font-weight: 700;
            margin-top: 15px;
        }

        .modal-actions {
            margin-top: 20px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .modal-actions button {
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
        }

        #confirm-payment-button {
            background-color: #28a745;
            color: white;
        }

        #cancel-payment-button {
            background-color: #f4f4f4;
            color: #555;
            border: 1px solid #ccc;
        }

        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            font-size: 1.2rem;
            font-weight: bold;
            color: #333;
            z-index: 2000;
        }

        #sync-button {
            background-color: #fff;
            color: #007bff;
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            font-size: 1.2rem;
            cursor: pointer;
            line-height: 32px;
            text-align: center;
            padding: 0;
            transition: background-color 0.2s;
        }

        #sync-button:hover {
            background-color: #f0f0f0;
        }

        /* === CSS STRUK & PRINT === */
        #receipt-container {
            display: none;
            font-family: 'Courier New', Courier, monospace;
            width: 300px;
            padding: 10px;
            font-size: 12px;
            color: #000;
            background: #fff;
        }
        #receipt-container h3 { text-align: center; font-size: 14px; margin: 0 0 5px 0; }
        #receipt-container p { margin: 3px 0; font-size: 11px; }
        #receipt-container hr { border: none; border-top: 1px dashed #000; margin: 8px 0; }
        #receipt-container table { width: 100%; border-collapse: collapse; font-size: 11px; }
        #receipt-container th,
        #receipt-container td { padding: 3px 0; vertical-align: top; }
        #receipt-container th { border-bottom: 1px solid #000; text-align: left; }
        #receipt-container .item-name { width: 40%; text-align: left; }
        #receipt-container .item-qty { width: 15%; text-align: center; }
        #receipt-container .item-price { width: 20%; text-align: right; }
        #receipt-container .subtotal { width: 25%; text-align: right; }
        #receipt-container .receipt-total { display: flex; justify-content: space-between; font-size: 14px; font-weight: bold; margin-top: 10px; }
        #receipt-container .receipt-footer { text-align: center; margin-top: 10px; font-size: 11px; }

        @media print {
            body> :not(#receipt-container) { display: none !important; }
            body { margin: 0; background: #fff; }
            #receipt-container { display: block !important; position: absolute; top: 0; left: 0; width: 100%; }
            @page { margin: 5mm; }
        }
        /* === AKHIR CSS STRUK === */

        /* === CSS MODAL STATUS === */
        #status-modal-message { margin: 15px 0; line-height: 1.5; }
        #status-modal-message strong { color: #0056b3; }
        .modal-btn-primary { background-color: #28a745; color: white; }
        .modal-btn-secondary { background-color: #f4f4f4; color: #555; border: 1px solid #ccc; }
        /* === AKHIR CSS MODAL STATUS === */


        /* === CSS BARU UNTUK TOMBOL & FORM TAMBAH BARANG === */
        header div {
            display: flex;
            gap: 10px; /* Jarak antar tombol di header */
        }

        #add-product-button {
            background-color: #fff;
            color: #007bff;
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            font-size: 1.2rem;
            cursor: pointer;
            line-height: 32px;
            text-align: center;
            padding: 0;
            transition: background-color 0.2s;
        }

        #add-product-button:hover {
            background-color: #f0f0f0;
        }

        /* Styling untuk form di modal */
        #add-product-form {
            display: flex;
            flex-direction: column;
            gap: 15px; /* Jarak antar isian */
            margin-top: 10px;
            overflow-y: auto;
            padding: 5px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 5px; /* Jarak antara label dan input */
        }

        .form-group label {
            font-weight: 600;
            font-size: 0.9rem;
            color: #555;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            font-size: 1rem;
            border: 1px solid #ccc;
            border-radius: 8px;
        }
        /* === AKHIR CSS BARU === */

    </style>
</head>

<body>

    <div class="container">

        <header>
            <span>Kasir Warung Adel</span>
            <div>
                <button id="add-product-button" title="Tambah Barang Baru">&#x2795;</button>
                <button id="sync-button" title="Sinkronisasi Ulang Produk">&#x1f504;</button>
            </div>
        </header>

        <div class="search-filter-container">
            <input type="search" id="search-bar" placeholder="Scan barcode atau cari nama barang...">
            <div class="category-filter" id="category-filter"></div>
        </div>

        <main id="product-list-container">
            <div id="product-list"></div>
            <p id="product-not-found">Barang tidak ditemukan</p>
        </main>

        <footer>
            <div class="cart-summary">
                <span class="total-items" id="cart-item-count">0 Item</span>
                <span class="total-price" id="total-price">Rp 0</span>
            </div>
            <div class="footer-actions">
                <button id="reset-cart-button" disabled>RESET</button>
                <button id="checkout-button" disabled>BAYAR</button>
            </div>
        </footer>
    </div>

    <div class="modal-overlay" id="checkout-modal">
        <div class="modal-content">
            <h3>Konfirmasi Pesanan</h3>
            <ul id="modal-cart-list"></ul>
            <div class="modal-total">
                <span>Total:</span>
                <span id="modal-total-price">Rp 0</span>
            </div>
            <div class="modal-actions">
                <button id="cancel-payment-button">Batal</button>
                <button id="confirm-payment-button">Konfirmasi Bayar</button>
            </div>
        </div>
    </div>

    <div id="loading-overlay">Memuat Produk...</div>

    <div id="receipt-container" style="display: none;">
        <h3>Warung Adel</h3>
        <p>ID Transaksi: <span id="receipt-id"></span></p>
        <p>Tanggal: <span id="receipt-date"></span></p>
        <hr>
        <table id="receipt-items">
            <thead>
                <tr>
                    <th class="item-name">Barang</th>
                    <th class="item-qty">Qty</th>
                    <th class="item-price">Harga</th>
                    <th class="subtotal">Total</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
        <hr>
        <p class="receipt-total">
            <strong>Total:</strong>
            <strong id="receipt-total">Rp 0</strong>
        </p>
        <p class="receipt-footer">Terima kasih!</p>
    </div>

    <div class="modal-overlay" id="status-modal">
        <div class="modal-content">
            <h3 id="status-modal-title">Judul Status</h3>
            <p id="status-modal-message">
                Pesan status akan muncul di sini.
            </p>
            <div class="modal-actions" id="status-modal-actions">
            </div>
        </div>
    </div>


    <div class="modal-overlay" id="add-product-modal">
        <div class="modal-content">
            <h3>Tambah Barang Baru</h3>
            
            <form id="add-product-form">
                
                <div class="form-group">
                    <label for="new-product-id">Barcode (ID):</label>
                    <input type="text" id="new-product-id" required placeholder="Scan barcode atau ketik ID unik">
                </div>
                <div class="form-group">
                    <label for="new-product-name">Nama Barang:</label>
                    <input type="text" id="new-product-name" required>
                </div>
                
                <div class="form-group">
                    <label for="new-product-price">Harga (Rp):</label>
                    <input type="number" id="new-product-price" min="0" step="50" required>
                </div>

                <div class="form-group">
                    <label for="new-product-stock">Stok Awal:</label>
                    <input type="number" id="new-product-stock" min="0" step="1" value="0" required>
                </div>
                <div class="form-group">
                    <label for="new-product-category">Kategori:</label>
                    <input list="category-list" id="new-product-category" required autocomplete="off" placeholder="Pilih atau ketik baru...">
                    <datalist id="category-list">
                    </datalist>
                </div>
                
                <div class="modal-actions">
                    <button type="button" id="cancel-add-product-button" class="modal-btn-secondary">Batal</button>
                    <button type="submit" id="save-product-button" class="modal-btn-primary">Simpan Barang</button>
                </div>
            </form>
        </div>
    </div>
    <script>
        // --- KONFIGURASI FRONTEND ---
        const GAS_URL = "https://script.google.com/macros/s/AKfycbzwL3LPD1CEmhPmAiVM2OvAxuHNadFjcHZw2v3ErjVsn_6qI8vR9LUN52pdQ5QeD5jo/exec"; // <-- GANTI DENGAN URL SCRIPT-MU
        const CACHE_KEY = 'kasirProducts';
        const CACHE_EXPIRATION_MS = 10 * 60 * 1000;

        // --- Variabel Global ---
        let allProducts = [];
        let categories = ['Semua'];
        let cart = [];
        let currentCategory = 'Semua';
        let currentSearch = '';
        let lastTransactionData = { id: null, cart: [] };

        // --- Elemen DOM ---
        const productListEl = document.getElementById('product-list');
        const productNotFoundEl = document.getElementById('product-not-found');
        const categoryFilterEl = document.getElementById('category-filter');
        const searchBarEl = document.getElementById('search-bar');
        const cartItemCountEl = document.getElementById('cart-item-count');
        const totalPriceEl = document.getElementById('total-price');
        const checkoutButton = document.getElementById('checkout-button');
        const resetCartButton = document.getElementById('reset-cart-button');
        const checkoutModal = document.getElementById('checkout-modal');
        const modalCartListEl = document.getElementById('modal-cart-list');
        const modalTotalPriceEl = document.getElementById('modal-total-price');
        const cancelPaymentButton = document.getElementById('cancel-payment-button');
        const confirmPaymentButton = document.getElementById('confirm-payment-button');
        const loadingOverlay = document.getElementById('loading-overlay');
        const syncButton = document.getElementById('sync-button');
        const receiptIdEl = document.getElementById('receipt-id');
        const receiptDateEl = document.getElementById('receipt-date');
        const receiptItemsEl = document.getElementById('receipt-items').querySelector('tbody');
        const receiptTotalEl = document.getElementById('receipt-total');
        const statusModal = document.getElementById('status-modal');
        const statusModalTitle = document.getElementById('status-modal-title');
        const statusModalMessage = document.getElementById('status-modal-message');
        const statusModalActions = document.getElementById('status-modal-actions');
        const addProductButton = document.getElementById('add-product-button');
        const addProductModal = document.getElementById('add-product-modal');
        const addProductForm = document.getElementById('add-product-form');
        const cancelAddProductButton = document.getElementById('cancel-add-product-button');
        const categoryDatalist = document.getElementById('category-list');

        // --- Fungsi-Fungsi ---

        function formatRupiah(number) {
            return new Intl.NumberFormat('id-ID', {
                style: 'currency', currency: 'IDR', minimumFractionDigits: 0
            }).format(number);
        }

        function printReceipt(transactionId, printedCart) {
            // (Tidak berubah)
            const now = new Date();
            const formattedDate = `${now.getDate()}/${now.getMonth() + 1}/${now.getFullYear()} ${now.getHours()}:${String(now.getMinutes()).padStart(2, '0')}`;
            let total = 0;
            receiptIdEl.textContent = transactionId;
            receiptDateEl.textContent = formattedDate;
            receiptItemsEl.innerHTML = '';
            printedCart.forEach(item => {
                const itemTotal = item.price * item.quantity;
                total += itemTotal;
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="item-name">${item.name}</td>
                    <td class="item-qty">${item.quantity}</td>
                    <td class="item-price">${formatRupiah(item.price)}</td>
                    <td class="subtotal">${formatRupiah(itemTotal)}</td>
                `;
                receiptItemsEl.appendChild(tr);
            });
            receiptTotalEl.textContent = formatRupiah(total);
            window.print();
        }

        function showStatusModal(title, message, buttonsHtml) {
            // (Tidak berubah)
            statusModalTitle.textContent = title;
            statusModalMessage.innerHTML = message;
            statusModalActions.innerHTML = buttonsHtml;
            statusModal.style.display = 'flex';
        }

        function hideStatusModal() {
            // (Modifikasi: Tambah fokus)
            statusModal.style.display = 'none';
            searchBarEl.focus(); // <-- FOKUS KEMBALI KE SEARCH
        }

        function triggerPrintAndClose() {
            // (Tidak berubah)
            if (lastTransactionData.id && lastTransactionData.cart.length > 0) {
                printReceipt(lastTransactionData.id, lastTransactionData.cart);
            }
            hideStatusModal();
            resetAfterCheckout();
        }

        function closeAndReset() {
            // (Tidak berubah)
            hideStatusModal();
            resetAfterCheckout();
        }

        function resetAfterCheckout() {
            // (Tidak berubah)
            cart = [];
            updateCartSummary();
            loadProducts(); // Load ulang produk untuk update stok visual
            lastTransactionData = { id: null, cart: [] };
        }

        function closeStatusModalOnError() {
            // (Tidak berubah)
            hideStatusModal();
        }

        function updateLocalStockAndCache(cartItems) {
            // (Tidak berubah)
            console.log("Updating local stock and cache...");
            let productsUpdated = false;
            cartItems.forEach(item => {
                const productInAll = allProducts.find(p => p.id === item.id);
                if (productInAll) {
                    productInAll.stock -= item.quantity;
                    if (productInAll.stock < 0) {
                        productInAll.stock = 0;
                    }
                    productsUpdated = true;
                }
            });
            if (productsUpdated) {
                try {
                    const cacheData = {
                        timestamp: Date.now(),
                        data: allProducts
                    };
                    localStorage.setItem(CACHE_KEY, JSON.stringify(cacheData));
                    console.log("Cache localStorage diperbarui setelah checkout.");
                } catch (e) {
                    console.error("Gagal memperbarui localStorage:", e);
                    localStorage.removeItem(CACHE_KEY);
                }
            }
        }

        function loadCategories() {
            // (Tidak berubah)
            const uniqueCategories = [...new Set(allProducts.map(p => p.category))];
            const validUniqueCategories = uniqueCategories.filter(c => c && c.trim() !== '');
            categories = ['Semua', ...validUniqueCategories];

            categoryFilterEl.innerHTML = '';
            categories.forEach(category => {
                const button = document.createElement('button');
                button.innerText = category;
                button.setAttribute('data-category', category);
                if (category === 'Semua') {
                    button.className = 'active';
                }
                button.addEventListener('click', () => filterByCategory(category));
                categoryFilterEl.appendChild(button);
            });

            const realCategories = categories.filter(c => c !== 'Semua');
            categoryDatalist.innerHTML = '';
            realCategories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                categoryDatalist.appendChild(option);
            });
        }

        function loadProducts() {
            // (Tidak berubah)
            productListEl.innerHTML = '';
            let filteredProducts = allProducts;
            if (currentCategory !== 'Semua') {
                filteredProducts = filteredProducts.filter(p => p.category === currentCategory);
            }
            if (currentSearch) {
                filteredProducts = filteredProducts.filter(p =>
                    p.name.toLowerCase().includes(currentSearch) ||
                    (p.id && p.id.toString().toLowerCase().includes(currentSearch))
                );
            }

            productNotFoundEl.style.display = filteredProducts.length === 0 ? 'block' : 'none';
            const validProducts = filteredProducts.filter(p => p.id && p.name);

            validProducts.forEach(product => {
                const item = document.createElement('div');
                item.className = 'product-item';
                item.setAttribute('data-id', product.id);
                item.innerHTML = `
                    <h4>${product.name}</h4>
                    <div>
                        <p>${formatRupiah(product.price)}</p>
                        <span class="stock">Stok: ${product.stock}</span>
                    </div>
                `;
                if (product.stock === 0) {
                    item.style.opacity = '0.5';
                    item.style.cursor = 'not-allowed';
                } else {
                    item.addEventListener('click', () => addToCart(product.id));
                }
                productListEl.appendChild(item);
            });
        }

        function filterByCategory(category) {
            // (Tidak berubah)
            currentCategory = category;
            document.querySelectorAll('.category-filter button').forEach(btn => {
                btn.classList.toggle('active', btn.getAttribute('data-category') === category);
            });
            loadProducts();
        }

        function filterBySearch(searchTerm) {
            // (Tidak berubah)
            currentSearch = searchTerm.toLowerCase();
            loadProducts();
        }

        function addToCart(productId) {
            // (Tidak berubah)
            const product = allProducts.find(p => p.id === productId);
            if (!product) return;
            const existingItem = cart.find(item => item.id === productId);
            const currentStock = product.stock;
            const cartQuantity = existingItem ? existingItem.quantity : 0;
            if (cartQuantity >= currentStock) {
                const title = "Stok Tidak Cukup";
                const message = `Stok ${product.name} tidak mencukupi. Sisa stok: ${currentStock}`;
                const buttonsHtml = `<button class="modal-btn-primary" onclick="closeStatusModalOnError()" style="grid-column: 1 / -1;">Tutup</button>`;
                showStatusModal(title, message, buttonsHtml);
                return;
            }
            if (existingItem) {
                existingItem.quantity++;
            } else {
                cart.push({
                    id: product.id, name: product.name, price: product.price, quantity: 1
                });
            }
            updateCartSummary();
        }

        function decrementCartItem(productId) {
            // (Tidak berubah)
            const existingItem = cart.find(item => item.id === productId);
            if (!existingItem) return;
            existingItem.quantity--;
            if (existingItem.quantity === 0) {
                cart = cart.filter(item => item.id !== productId);
            }
            if (cart.length === 0) {
                hideCheckoutModal();
            }
        }

        function updateCartSummary() {
            // (Tidak berubah)
            let totalItems = 0;
            let totalPrice = 0;
            cart.forEach(item => {
                totalItems += item.quantity;
                totalPrice += item.price * item.quantity;
            });
            cartItemCountEl.textContent = `${totalItems} Item`;
            totalPriceEl.textContent = formatRupiah(totalPrice);
            const isEmpty = cart.length === 0;
            checkoutButton.disabled = isEmpty;
            resetCartButton.disabled = isEmpty;
        }

        function showCheckoutModal() {
            // (Tidak berubah)
            modalCartListEl.innerHTML = '';
            let totalPrice = 0;
            const sortedCart = [...cart].reverse();
            sortedCart.forEach(item => {
                const li = document.createElement('li');
                const itemTotal = item.price * item.quantity;
                const product = allProducts.find(p => p.id === item.id);
                const isStockMaxed = (product && item.quantity >= product.stock);
                li.innerHTML = `
                    <span class="item-name">${item.name}</span>
                    <div class="item-qty-controls">
                        <button class="modal-qty-btn modal-qty-minus" data-id="${item.id}">-</button>
                        <span>${item.quantity}</span>
                        <button class="modal-qty-btn modal-qty-plus" data-id="${item.id}" ${isStockMaxed ? 'disabled' : ''}>+</button>
                    </div>
                    <span class="item-total">${formatRupiah(itemTotal)}</span>
                `;
                modalCartListEl.appendChild(li);
                totalPrice += itemTotal;
            });
            modalTotalPriceEl.textContent = formatRupiah(totalPrice);
            if (cart.length > 0) {
                checkoutModal.style.display = 'flex';
            } else {
                hideCheckoutModal();
            }
        }

        function hideCheckoutModal() {
            // (Modifikasi: Tambah fokus)
            checkoutModal.style.display = 'none';
            searchBarEl.focus(); // <-- FOKUS KEMBALI KE SEARCH
        }

        async function processCheckout() {
            // (Tidak berubah)
            if (cart.length === 0) return;
            const cartToPrint = JSON.parse(JSON.stringify(cart));
            hideCheckoutModal();
            loadingOverlay.style.display = 'flex';
            loadingOverlay.textContent = 'Memproses...';

            try {
                const payload = cart; // Ini adalah payload checkout
                const response = await fetch(GAS_URL, {
                    method: 'POST',
                    mode: 'cors',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify(payload),
                });
                const result = await response.json();

                if (result.status === "success") {
                    updateLocalStockAndCache(cartToPrint);
                    lastTransactionData.id = result.transactionId;
                    lastTransactionData.cart = cartToPrint;
                    const title = "Transaksi Berhasil!";
                    const message = `ID Transaksi: <strong>${result.transactionId}</strong><br>Apakah Anda ingin mencetak struk?`;
                    const buttonsHtml = `
                        <button class="modal-btn-secondary" onclick="closeAndReset()">Selesai (Tanpa Struk)</button>
                        <button class="modal-btn-primary" onclick="triggerPrintAndClose()">Cetak Struk</button>
                    `;
                    loadingOverlay.style.display = 'none';
                    showStatusModal(title, message, buttonsHtml);
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                console.error('Error saat checkout:', error);
                const title = "Transaksi Gagal";
                const message = `Terjadi kesalahan: ${error.message}. Silakan coba lagi.`;
                const buttonsHtml = `<button class="modal-btn-primary" onclick="closeStatusModalOnError()" style="grid-column: 1 / -1;">Tutup</button>`;
                loadingOverlay.style.display = 'none';
                showStatusModal(title, message, buttonsHtml);
            }
        }

        function resetCart() {
            // (Tidak berubah)
            if (cart.length === 0) return;
            const title = "Reset Keranjang";
            const message = "Apakah Anda yakin ingin mengosongkan keranjang?";
            const buttonsHtml = `
                <button class="modal-btn-secondary" onclick="hideStatusModal()">Batal</button>
                <button id="confirm-reset-button" class="modal-btn-primary" style="background-color:#dc3545;">Ya, Kosongkan</button>
            `;
            showStatusModal(title, message, buttonsHtml);
            document.getElementById('confirm-reset-button').addEventListener('click', () => {
                cart = [];
                updateCartSummary();
                hideStatusModal();
            }, { once: true });
        }

        async function fetchProducts(forceSync = false) {
            // (Tidak berubah)
            loadingOverlay.style.display = 'flex';
            loadingOverlay.textContent = forceSync ? 'Sinkronisasi Ulang...' : 'Memuat Produk...';

            if (forceSync) {
                localStorage.removeItem(CACHE_KEY);
                console.log("Cache produk dihapus (Sync Paksa).");
            } else {
                try {
                    const cachedItem = localStorage.getItem(CACHE_KEY);
                    if (cachedItem) {
                        const { timestamp, data } = JSON.parse(cachedItem);
                        if (Date.now() - timestamp < CACHE_EXPIRATION_MS) {
                            console.log("Memuat produk dari localStorage cache...");
                            allProducts = data;
                            loadCategories();
                            loadProducts();
                            loadingOverlay.style.display = 'none';
                            return;
                        } else {
                            console.log("Cache produk kadaluarsa.");
                            localStorage.removeItem(CACHE_KEY);
                        }
                    }
                } catch (e) {
                    console.error("Gagal membaca cache:", e);
                    localStorage.removeItem(CACHE_KEY);
                }
            }

            console.log("Fetching produk dari server...");
            let url = GAS_URL;
            if (forceSync) {
                url += "?action=clearCache";
            }

            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error('Gagal mengambil data produk dari server.');
                }
                const data = await response.json();
                allProducts = data;

                try {
                    const cacheData = {
                        timestamp: Date.now(),
                        data: allProducts
                    };
                    localStorage.setItem(CACHE_KEY, JSON.stringify(cacheData));
                    console.log("Produk disimpan ke localStorage cache.");
                } catch (e) {
                    console.error("Gagal menyimpan ke localStorage:", e);
                }

                loadCategories();
                loadProducts();
            } catch (error) {
                console.error('Error fetching products:', error);
                const title = "Gagal Memuat Produk";
                const message = `Gagal memuat produk. Cek koneksi atau URL Google Apps Script. (${error.message})`;
                const buttonsHtml = `<button class="modal-btn-primary" onclick="closeStatusModalOnError()" style="grid-column: 1 / -1;">Tutup</button>`;
                showStatusModal(title, message, buttonsHtml);
                productListEl.innerHTML = '<p>Gagal memuat produk.</p>';
            } finally {
                loadingOverlay.style.display = 'none';
            }
        }


        // === FUNGSI DIMODIFIKASI: handleSaveProduct ===
        // Sekarang juga mengirim data ID dari form
        async function handleSaveProduct(e) {
            e.preventDefault(); 

            // 1. Ambil data dari form
            const productId = document.getElementById('new-product-id').value.trim(); // <-- BARU
            const productName = document.getElementById('new-product-name').value;
            const productPrice = parseFloat(document.getElementById('new-product-price').value);
            const productStock = parseInt(document.getElementById('new-product-stock').value);
            const productCategory = document.getElementById('new-product-category').value;

            // Validasi (termasuk ID)
            if (!productId || !productName || !productCategory || isNaN(productPrice) || productPrice <= 0 || isNaN(productStock) || productStock < 0) { // <-- DIMODIFIKASI
                const title = "Input Tidak Valid";
                const message = "Pastikan Barcode (ID), Nama, Harga (angka positif), Stok (angka 0 atau lebih), dan Kategori sudah terisi dengan benar."; // <-- DIMODIFIKASI
                const buttonsHtml = `<button class="modal-btn-primary" onclick="closeStatusModalOnError()" style="grid-column: 1 / -1;">Tutup</button>`;
                showStatusModal(title, message, buttonsHtml);
                return;
            }

            // 2. Tampilkan loading
            addProductModal.style.display = 'none';
            loadingOverlay.style.display = 'flex';
            loadingOverlay.textContent = 'Menyimpan Barang...';

            // 3. Buat payload untuk dikirim ke backend
            const payload = {
                action: "addProduct",
                product: {
                    id: productId, // <-- BARU
                    name: productName,
                    price: productPrice,
                    category: productCategory,
                    stock: productStock
                }
            };

            // 4. Kirim ke Google Apps Script
            try {
                const response = await fetch(GAS_URL, {
                    method: 'POST',
                    mode: 'cors',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify(payload),
                });
                const result = await response.json();

                if (result.status === "success") {
                    loadingOverlay.style.display = 'none';
                    
                    const title = "Berhasil!";
                    const message = `Barang <strong>${productName}</strong> (ID: ${result.newId}) berhasil ditambahkan.<br>Memuat ulang daftar produk...`;
                    const buttonsHtml = `<button id="close-success-add-btn" class="modal-btn-primary" style="grid-column: 1 / -1;">OK</button>`;
                    showStatusModal(title, message, buttonsHtml);

                    document.getElementById('close-success-add-btn').addEventListener('click', () => {
                        hideStatusModal();
                        fetchProducts(true); // Paksa sinkronisasi ulang
                    }, { once: true });

                    addProductForm.reset(); 

                } else {
                    throw new Error(result.message); // Akan menangkap error (misal: ID duplikat)
                }

            } catch (error) {
                console.error('Error saat tambah produk:', error);
                loadingOverlay.style.display = 'none';
                
                const title = "Gagal Menyimpan";
                const message = `Terjadi kesalahan: ${error.message}. Silakan coba lagi.`;
                const buttonsHtml = `<button class="modal-btn-primary" onclick="closeStatusModalOnError()" style="grid-column: 1 / -1;">Tutup</button>`;
                showStatusModal(title, message, buttonsHtml);

                addProductModal.style.display = 'flex'; // Tampilkan lagi modal form-nya
            }
        }
        // === AKHIR FUNGSI DIMODIFIKASI ===


        // --- Event Listeners ---
        searchBarEl.addEventListener('input', (e) => filterBySearch(e.target.value));
        checkoutButton.addEventListener('click', showCheckoutModal);
        resetCartButton.addEventListener('click', resetCart);
        cancelPaymentButton.addEventListener('click', hideCheckoutModal);
        confirmPaymentButton.addEventListener('click', processCheckout);

        syncButton.addEventListener('click', () => {
            // (Tidak berubah)
            const title = "Sinkronisasi Ulang";
            const message = "Sinkronisasi ulang akan memuat data terbaru dari Google Sheet.<br>Lanjutkan?";
            const buttonsHtml = `
                <button class="modal-btn-secondary" onclick="hideStatusModal()">Batal</button>
                <button id="confirm-sync-button" class="modal-btn-primary">Lanjutkan</button>
            `;
            showStatusModal(title, message, buttonsHtml);
            document.getElementById('confirm-sync-button').addEventListener('click', () => {
                hideStatusModal();
                fetchProducts(true);
            }, { once: true });
        });

        modalCartListEl.addEventListener('click', (e) => {
            // (Tidak berubah)
            const target = e.target;
            if (target.classList.contains('modal-qty-plus')) {
                const id = target.dataset.id;
                addToCart(id);
                showCheckoutModal();
                updateCartSummary();
            }
            if (target.classList.contains('modal-qty-minus')) {
                const id = target.dataset.id;
                decrementCartItem(id);
                showCheckoutModal();
                updateCartSummary();
            }
        });

        addProductButton.addEventListener('click', () => {
            // (Tidak berubah)
            addProductModal.style.display = 'flex';
            // Fokus ke field ID baru
            document.getElementById('new-product-id').focus();
        });

        cancelAddProductButton.addEventListener('click', () => {
            // (Modifikasi: Tambah fokus)
            addProductForm.reset();
            addProductModal.style.display = 'none';
            searchBarEl.focus(); // <-- FOKUS KEMBALI KE SEARCH
        });

        addProductForm.addEventListener('submit', handleSaveProduct);


        // --- Inisialisasi Aplikasi ---
        document.addEventListener('DOMContentLoaded', () => {
            fetchProducts();
            updateCartSummary();
            
            searchBarEl.focus(); // Langsung fokus ke search bar saat aplikasi dimuat

            // --- KODE BARCODE SCANNING (TAMBAHAN BARU) ---
            searchBarEl.addEventListener('keypress', function(e) {
                // Hanya jalankan jika tombol 'Enter' ditekan
                if (e.key === 'Enter') {
                    e.preventDefault(); // Mencegah aksi default 'Enter' (misal: submit form)
                    const barcode = searchBarEl.value.trim();
                    if (barcode === "") return; // Jangan lakukan apa-apa jika kosong

                    // Cari produk berdasarkan ID (barcode)
                    // Kita pakai .find() agar lebih cepat dan case-insensitive
                    const product = allProducts.find(p => p.id && p.id.toString().toLowerCase() === barcode.toLowerCase());

                    if (product) {
                        // Jika ketemu, langsung tambahkan ke keranjang
                        addToCart(product.id);
                        searchBarEl.value = ''; // Kosongkan search bar
                    } else {
                        // Jika tidak ketemu, tampilkan notifikasi
                        const title = "Barang Tidak Ditemukan";
                        const message = `Barang dengan barcode/ID <strong>${barcode}</strong> tidak ditemukan.`;
                        const buttonsHtml = `<button class="modal-btn-primary" onclick="closeStatusModalOnError()" style="grid-column: 1 / -1;">Tutup</button>`;
                        showStatusModal(title, message, buttonsHtml);
                        // search bar akan otomatis fokus saat modal ditutup
                    }
                }
            });
            // --- AKHIR KODE BARCODE SCANNING ---
        });

    </script>
</body>

</html>