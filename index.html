<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kasir</title>

    <!-- Ganti library scanner -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>

    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: #f0f2f5;
            color: #333;
            height: 100dvh;
            overflow: hidden;
        }

        .container {
            display: flex;
            flex-direction: column;
            height: 100%;
            max-width: 600px;
            margin: 0 auto;
            background-color: #ffffff;
        }

        header {
            background-color: #007bff;
            color: white;
            padding: 12px 15px;
            font-size: 1.1rem;
            font-weight: 600;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            flex-shrink: 0;
            z-index: 10;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .search-filter-container {
            padding: 10px 15px;
            background-color: #fff;
            border-bottom: 1px solid #ddd;
            flex-shrink: 0;
            position: sticky;
            top: 0;
            z-index: 9;
        }

        .search-wrapper {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        #search-bar {
            width: 100%;
            padding: 12px;
            font-size: 1rem;
            border: 1px solid #ccc;
            border-radius: 8px;
            flex-grow: 1;
        }

        .scan-btn {
            flex-shrink: 0;
            width: 44px;
            height: 44px;
            padding: 10px;
            font-size: 1.2rem;
            cursor: pointer;
            border: 1px solid #007bff;
            background-color: #f0f8ff;
            color: #007bff;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .category-filter {
            display: flex;
            overflow-x: auto;
            padding: 10px 0 5px 0;
            white-space: nowrap;
        }

        .category-filter::-webkit-scrollbar {
            height: 5px;
        }

        .category-filter::-webkit-scrollbar-thumb {
            background: #ccc;
            border-radius: 10px;
        }

        .category-filter button {
            padding: 8px 15px;
            margin-right: 8px;
            border: 1px solid #007bff;
            background-color: #fff;
            color: #007bff;
            border-radius: 20px;
            font-size: 0.85rem;
            cursor: pointer;
            flex-shrink: 0;
        }

        .category-filter button.active {
            background-color: #007bff;
            color: #fff;
            font-weight: 600;
        }

        main {
            flex-grow: 1;
            overflow-y: auto;
            padding: 10px 15px;
            background-color: #f9f9f9;
        }

        #product-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 12px;
        }

        .product-item {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 10px;
            text-align: center;
            background-color: #fff;
            cursor: pointer;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s, box-shadow 0.2s;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .product-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .product-item h4 {
            margin: 5px 0;
            font-size: 0.85rem;
            color: #333;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
            min-height: 2.5em;
        }

        .product-item p {
            margin: 0;
            font-size: 0.9rem;
            color: #0056b3;
            font-weight: 600;
        }

        .product-item .stock {
            font-size: 0.75rem;
            color: #666;
        }

        #product-not-found {
            display: none;
            text-align: center;
            padding: 30px;
            color: #888;
        }

        footer {
            flex-shrink: 0;
            border-top: 1px solid #ccc;
            background-color: #fff;
            padding: 15px;
            box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.08);
            z-index: 10;
        }

        .cart-summary {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .cart-summary .total-items {
            font-size: 0.9rem;
            color: #555;
        }

        .cart-summary .total-price {
            font-size: 1.2rem;
            font-weight: 700;
            color: #007bff;
        }

        .footer-actions {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 10px;
            margin-top: 10px;
        }

        #checkout-button {
            padding: 15px;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
        }

        #checkout-button:disabled {
            background-color: #aaa;
            cursor: not-allowed;
        }

        #reset-cart-button {
            padding: 15px;
            background-color: #fff;
            color: #dc3545;
            border: 1px solid #dc3545;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
        }

        #reset-cart-button:disabled {
            background-color: #f4f4f4;
            color: #aaa;
            border-color: #ccc;
            cursor: not-allowed;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: #fff;
            padding: 20px;
            border-radius: 12px;
            width: 90%;
            max-width: 400px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
        }

        .modal-content h3 {
            margin-bottom: 15px;
            text-align: center;
            color: #333;
        }

        #modal-cart-list {
            list-style: none;
            overflow-y: auto;
            flex-grow: 1;
            border-top: 1px solid #eee;
            border-bottom: 1px solid #eee;
        }

        #modal-cart-list li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 5px;
            border-bottom: 1px solid #f4f4f4;
        }

        #modal-cart-list .item-name {
            font-size: 0.9rem;
            flex: 2.5;
            margin-right: 5px;
            line-height: 1.3;
        }

        #modal-cart-list .item-qty-controls {
            flex: 1.5;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 1rem;
            font-weight: 600;
        }

        .modal-qty-btn {
            background-color: #f0f2f5;
            border: none;
            border-radius: 50%;
            font-weight: bold;
            color: #007bff;
            width: 28px;
            height: 28px;
            font-size: 1.2rem;
            line-height: 28px;
            text-align: center;
            cursor: pointer;
        }

        .modal-qty-btn:disabled {
            color: #aaa;
            background-color: #f9f9f9;
            cursor: not-allowed;
        }

        #modal-cart-list .item-total {
            font-size: 0.95rem;
            font-weight: 600;
            flex: 1.5;
            text-align: right;
        }

        .modal-total {
            display: flex;
            justify-content: space-between;
            font-size: 1.2rem;
            font-weight: 700;
            margin-top: 15px;
        }

        .modal-actions {
            margin-top: 20px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .modal-actions button {
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
        }

        #confirm-payment-button {
            background-color: #28a745;
            color: white;
        }

        #cancel-payment-button {
            background-color: #f4f4f4;
            color: #555;
            border: 1px solid #ccc;
        }

        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            font-size: 1.2rem;
            font-weight: bold;
            color: #333;
            z-index: 2000;
        }

        #sync-button {
            background-color: #fff;
            color: #007bff;
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            font-size: 1.2rem;
            cursor: pointer;
            line-height: 32px;
            text-align: center;
            padding: 0;
            transition: background-color 0.2s;
        }

        #sync-button:hover {
            background-color: #f0f0f0;
        }

        /* === CSS STRUK & PRINT === */
        #receipt-container {
            display: none;
            font-family: 'Courier New', Courier, monospace;
            width: 300px;
            padding: 10px;
            font-size: 12px;
            color: #000;
            background: #fff;
        }

        #receipt-container h3 {
            text-align: center;
            font-size: 14px;
            margin: 0 0 5px 0;
        }

        #receipt-container p {
            margin: 3px 0;
            font-size: 11px;
        }

        #receipt-container hr {
            border: none;
            border-top: 1px dashed #000;
            margin: 8px 0;
        }

        #receipt-container table {
            width: 100%;
            border-collapse: collapse;
            font-size: 11px;
        }

        #receipt-container th,
        #receipt-container td {
            padding: 3px 0;
            vertical-align: top;
        }

        #receipt-container th {
            border-bottom: 1px solid #000;
            text-align: left;
        }

        #receipt-container .item-name {
            width: 40%;
            text-align: left;
        }

        #receipt-container .item-qty {
            width: 15%;
            text-align: center;
        }

        #receipt-container .item-price {
            width: 20%;
            text-align: right;
        }

        #receipt-container .subtotal {
            width: 25%;
            text-align: right;
        }

        #receipt-container .receipt-total {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            font-weight: bold;
            margin-top: 10px;
        }

        #receipt-container .receipt-footer {
            text-align: center;
            margin-top: 10px;
            font-size: 11px;
        }

        @media print {
            body> :not(#receipt-container) {
                display: none !important;
            }

            body {
                margin: 0;
                background: #fff;
            }

            #receipt-container {
                display: block !important;
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
            }

            @page {
                margin: 5mm;
            }
        }

        /* === AKHIR CSS STRUK === */

        /* === CSS MODAL STATUS === */
        #status-modal-message {
            margin: 15px 0;
            line-height: 1.5;
        }

        #status-modal-message strong {
            color: #0056b3;
        }

        .modal-btn-primary {
            background-color: #28a745;
            color: white;
        }

        .modal-btn-secondary {
            background-color: #f4f4f4;
            color: #555;
            border: 1px solid #ccc;
        }

        /* === AKHIR CSS MODAL STATUS === */


        /* === CSS UNTUK TOMBOL & FORM TAMBAH BARANG === */
        header div {
            display: flex;
            gap: 10px;
        }

        #add-product-button {
            background-color: #fff;
            color: #007bff;
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            font-size: 1.2rem;
            cursor: pointer;
            line-height: 32px;
            text-align: center;
            padding: 0;
            transition: background-color 0.2s;
        }

        #add-product-button:hover {
            background-color: #f0f0f0;
        }

        #add-product-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 10px;
            overflow-y: auto;
            padding: 5px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .form-group-inline {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .form-group-inline .form-group {
            flex-grow: 1;
            margin: 0;
        }

        .form-group-inline .scan-btn {
            height: 44px;
            margin-bottom: 2px;
        }

        .form-group label {
            font-weight: 600;
            font-size: 0.9rem;
            color: #555;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            font-size: 1rem;
            border: 1px solid #ccc;
            border-radius: 8px;
        }


        /* === CSS Untuk Modal Scanner === */
        #scanner-modal .modal-content {
            max-height: 90vh; /* Sesuaikan jika perlu */
            overflow: hidden; /* Tetap sembunyikan overflow modal */
        }

        #scanner-container {
            position: relative; 
            width: 100%;
            /* Tentukan aspect ratio (misal 4:3) menggunakan padding-bottom trick */
            padding-bottom: 75%; /* 3 / 4 * 100% */
            height: 0; /* Tinggi harus 0 untuk padding-bottom trick */
            max-width: 500px;
            margin: 10px auto 0 auto; 
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden; /* Sembunyikan bagian video yang keluar */
            background-color: #333; 
        }

        /* CSS untuk div viewport QuaggaJS */
        #interactive.viewport {
            position: absolute; /* Mengisi #scanner-container */
            top: 0;
            left: 0;
            width: 100%;
            height: 100%; 
            overflow: hidden;
        }
        /* Style video dan canvas QuaggaJS */
        #interactive.viewport video,
        #interactive.viewport canvas {
            position: absolute;
            top: 50%;
            left: 50%;
            /* Prioritaskan mengisi tinggi, biarkan lebar menyesuaikan */
            width: auto; 
            height: 100%; 
            /* Atau prioritaskan mengisi lebar jika orientasi kamera landscape */
            /* width: 100%; */
            /* height: auto; */
            transform: translate(-50%, -50%);
             /* Pastikan minimal mengisi container */
             min-width: 100%;
             min-height: 100%;
             object-fit: cover; /* Hindari distorsi, potong jika perlu */
        }
        /* Canvas untuk drawing box Quagga bisa ditumpuk */
        #interactive.viewport canvas.drawingBuffer {
            z-index: 5;
            pointer-events: none;
            position: absolute; /* Pastikan posisinya absolut */
             top: 0;
             left: 0;
             width: 100%;
             height: 100%;
        }
        
        #scanner-modal .modal-actions {
            margin-top: 15px;
            grid-template-columns: 1fr; /* Hanya satu tombol "Batal" */
        }

        /* === CSS BARU UNTUK TAMPILAN SCANNER === */
        .scanner-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            pointer-events: none; /* Agar tidak menghalangi interaksi */
            z-index: 10; /* Pastikan di atas video & canvas quagga */
        }

        .scanner-window {
            width: 80%; /* Lebar area pemindaian relatif */
            max-width: 300px; /* Batas lebar maksimum */
             /* Tinggi dibuat lebih pendek, cocok untuk barcode EAN */
             height: 100px; 
            position: relative;
            box-shadow: 0 0 0 100vmax rgba(0, 0, 0, 0.5); /* Overlay gelap di luar window */
            border-radius: 5px; /* Sedikit lengkungan */
        }

        .scanner-laser {
            position: absolute;
            top: 10%;
            left: 5%;
            right: 5%;
            height: 2px;
            background-color: red;
            box-shadow: 0 0 5px red, 0 0 2px red inset; /* Efek glow */
            border-radius: 1px;
            animation: scan-animation 2.5s infinite linear; /* Durasi animasi */
        }

        .scanner-corner {
            position: absolute;
            width: 25px; /* Ukuran sudut */
            height: 25px; /* Ukuran sudut */
            border: 4px solid white; /* Ketebalan dan warna sudut */
            border-radius: 3px; /* Sedikit lengkungan di sudut */
        }
        /* Posisi sudut */
        .scanner-corner.top-left { top: -4px; left: -4px; border-right: none; border-bottom: none; }
        .scanner-corner.top-right { top: -4px; right: -4px; border-left: none; border-bottom: none; }
        .scanner-corner.bottom-left { bottom: -4px; left: -4px; border-right: none; border-top: none; }
        .scanner-corner.bottom-right { bottom: -4px; right: -4px; border-left: none; border-top: none; }

        .scanner-instruction {
            color: white;
            margin-top: 20px; /* Jarak dari window scanner */
            font-size: 0.9rem;
            background-color: rgba(0, 0, 0, 0.5); /* Background semi-transparan */
            padding: 6px 12px;
            border-radius: 4px;
            text-align: center;
        }

        /* Animasi laser */
        @keyframes scan-animation {
            0% { top: 10%; opacity: 1; }
            50% { top: 90%; opacity: 1; }
            60% { top: 90%; opacity: 1; }
            100% { top: 10%; opacity: 1; }
        }
        /* === AKHIR CSS BARU === */
        
    </style>
</head>

<body>

    <div class="container">

        <header>
            <span>Kasir Warung Adel</span>
            <div>
                <button id="add-product-button" title="Tambah Barang Baru">&#x2795;</button>
                <button id="sync-button" title="Sinkronisasi Ulang Produk">&#x1f504;</button>
            </div>
        </header>

        <div class="search-filter-container">
            <div class="search-wrapper">
                <input type="search" id="search-bar" placeholder="Scan barcode atau cari nama barang...">
                <button id="scan-for-sell-button" class="scan-btn" title="Scan Barcode">&#128247;</button>
            </div>
            <div class="category-filter" id="category-filter"></div>
        </div>

        <main id="product-list-container">
            <div id="product-list"></div>
            <p id="product-not-found">Barang tidak ditemukan</p>
        </main>

        <footer>
            <div class="cart-summary">
                <span class="total-items" id="cart-item-count">0 Item</span>
                <span class="total-price" id="total-price">Rp 0</span>
            </div>
            <div class="footer-actions">
                <button id="reset-cart-button" disabled>RESET</button>
                <button id="checkout-button" disabled>BAYAR</button>
            </div>
        </footer>
    </div>

    <div class="modal-overlay" id="checkout-modal">
        <div class="modal-content">
            <h3>Konfirmasi Pesanan</h3>
            <ul id="modal-cart-list"></ul>
            <div class="modal-total">
                <span>Total:</span>
                <span id="modal-total-price">Rp 0</span>
            </div>
            <div class="modal-actions">
                <button id="cancel-payment-button">Batal</button>
                <button id="confirm-payment-button">Konfirmasi Bayar</button>
            </div>
        </div>
    </div>

    <div id="loading-overlay">Memuat Produk...</div>

    <div id="receipt-container" style="display: none;">
        <h3>Warung Adel</h3>
        <p>ID Transaksi: <span id="receipt-id"></span></p>
        <p>Tanggal: <span id="receipt-date"></span></p>
        <hr>
        <table id="receipt-items">
            <thead>
                <tr>
                    <th class="item-name">Barang</th>
                    <th class="item-qty">Qty</th>
                    <th class="item-price">Harga</th>
                    <th class="subtotal">Total</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
        <hr>
        <p class="receipt-total">
            <strong>Total:</strong>
            <strong id="receipt-total">Rp 0</strong>
        </p>
        <p class="receipt-footer">Terima kasih!</p>
    </div>

    <div class="modal-overlay" id="status-modal">
        <div class="modal-content">
            <h3 id="status-modal-title">Judul Status</h3>
            <p id="status-modal-message">
                Pesan status akan muncul di sini.
            </p>
            <div class="modal-actions" id="status-modal-actions">
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="add-product-modal">
        <div class="modal-content">
            <h3>Tambah Barang Baru</h3>

            <form id="add-product-form">

                <div class="form-group-inline">
                    <div class="form-group">
                        <label for="new-product-id">Barcode (ID):</label>
                        <input type="text" id="new-product-id" required placeholder="Scan atau ketik ID...">
                    </div>
                    <button type="button" id="scan-for-add-button" class="scan-btn"
                        title="Scan Barcode">&#128247;</button>
                </div>
                <div class="form-group">
                    <label for="new-product-name">Nama Barang:</label>
                    <input type="text" id="new-product-name" required>
                </div>

                <div class="form-group">
                    <label for="new-product-price">Harga (Rp):</label>
                    <input type="number" id="new-product-price" min="0" step="50" required>
                </div>

                <div class="form-group">
                    <label for="new-product-stock">Stok Awal:</label>
                    <input type="number" id="new-product-stock" min="0" step="1" value="0" required>
                </div>
                <div class="form-group">
                    <label for="new-product-category">Kategori:</label>
                    <input list="category-list" id="new-product-category" required autocomplete="off"
                        placeholder="Pilih atau ketik baru...">
                    <datalist id="category-list">
                    </datalist>
                </div>

                <div class="modal-actions">
                    <button type="button" id="cancel-add-product-button" class="modal-btn-secondary">Batal</button>
                    <button type="submit" id="save-product-button" class="modal-btn-primary">Simpan Barang</button>
                </div>
            </form>
        </div>
    </div>


    <div class="modal-overlay" id="scanner-modal">
        <div class="modal-content">
            <h3>Scan Barcode</h3>
            <div id="scanner-container">
                 <div id="interactive" class="viewport"></div> 
                 <div class="scanner-overlay">
                    <div class="scanner-window">
                        <div class="scanner-laser"></div>
                        <div class="scanner-corner top-left"></div>
                        <div class="scanner-corner top-right"></div>
                        <div class="scanner-corner bottom-left"></div>
                        <div class="scanner-corner bottom-right"></div>
                    </div>
                    <p class="scanner-instruction">Posisikan barcode di dalam area</p>
                </div>
            </div>
            <div class="modal-actions">
                <button id="cancel-scan-button" class="modal-btn-secondary">Batal</button>
            </div>
        </div>
    </div>
    
    <script>
        // --- KONFIGURASI FRONTEND ---
        const GAS_URL = "https://script.google.com/macros/s/AKfycbzwL3LPD1CEmhPmAiVM2OvAxuHNadFjcHZw2v3ErjVsn_6qI8vR9LUN52pdQ5QeD5jo/exec"; // <-- GANTI DENGAN URL SCRIPT-MU
        const CACHE_KEY = 'kasirProducts';
        const CACHE_EXPIRATION_MS = 10 * 60 * 1000;

        // --- Variabel Global ---
        let allProducts = [];
        let categories = ['Semua'];
        let cart = [];
        let currentCategory = 'Semua';
        let currentSearch = '';
        let lastTransactionData = { id: null, cart: [] };

        // Variabel untuk scanner QuaggaJS
        let scannerPurpose = null; // 'sell' atau 'add'
        let isQuaggaRunning = false; // Flag untuk status Quagga


        // --- Elemen DOM ---
        const productListEl = document.getElementById('product-list');
        const productNotFoundEl = document.getElementById('product-not-found');
        const categoryFilterEl = document.getElementById('category-filter');
        const searchBarEl = document.getElementById('search-bar');
        const cartItemCountEl = document.getElementById('cart-item-count');
        const totalPriceEl = document.getElementById('total-price');
        const checkoutButton = document.getElementById('checkout-button');
        const resetCartButton = document.getElementById('reset-cart-button');
        const checkoutModal = document.getElementById('checkout-modal');
        const modalCartListEl = document.getElementById('modal-cart-list');
        const modalTotalPriceEl = document.getElementById('modal-total-price');
        const cancelPaymentButton = document.getElementById('cancel-payment-button');
        const confirmPaymentButton = document.getElementById('confirm-payment-button');
        const loadingOverlay = document.getElementById('loading-overlay');
        const syncButton = document.getElementById('sync-button');
        const receiptIdEl = document.getElementById('receipt-id');
        const receiptDateEl = document.getElementById('receipt-date');
        const receiptItemsEl = document.getElementById('receipt-items').querySelector('tbody');
        const receiptTotalEl = document.getElementById('receipt-total');
        const statusModal = document.getElementById('status-modal');
        const statusModalTitle = document.getElementById('status-modal-title');
        const statusModalMessage = document.getElementById('status-modal-message');
        const statusModalActions = document.getElementById('status-modal-actions');
        const addProductButton = document.getElementById('add-product-button');
        const addProductModal = document.getElementById('add-product-modal');
        const addProductForm = document.getElementById('add-product-form');
        const cancelAddProductButton = document.getElementById('cancel-add-product-button');
        const categoryDatalist = document.getElementById('category-list');
        const scannerModal = document.getElementById('scanner-modal');
        const scanForSellButton = document.getElementById('scan-for-sell-button');
        const scanForAddButton = document.getElementById('scan-for-add-button');
        const cancelScanButton = document.getElementById('cancel-scan-button');
        const scannerContainer = document.getElementById('scanner-container'); // Container untuk Quagga


        // --- Fungsi-Fungsi ---

        function formatRupiah(number) {
            return new Intl.NumberFormat('id-ID', {
                style: 'currency', currency: 'IDR', minimumFractionDigits: 0
            }).format(number);
        }

        function printReceipt(transactionId, printedCart) {
            const now = new Date();
            const formattedDate = `${now.getDate()}/${now.getMonth() + 1}/${now.getFullYear()} ${now.getHours()}:${String(now.getMinutes()).padStart(2, '0')}`;
            let total = 0;
            receiptIdEl.textContent = transactionId;
            receiptDateEl.textContent = formattedDate;
            receiptItemsEl.innerHTML = '';
            printedCart.forEach(item => {
                const itemTotal = item.price * item.quantity;
                total += itemTotal;
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="item-name">${item.name}</td>
                    <td class="item-qty">${item.quantity}</td>
                    <td class="item-price">${formatRupiah(item.price)}</td>
                    <td class="subtotal">${formatRupiah(itemTotal)}</td>
                `;
                receiptItemsEl.appendChild(tr);
            });
            receiptTotalEl.textContent = formatRupiah(total);
            window.print();
        }

        function showStatusModal(title, message, buttonsHtml) {
            statusModalTitle.textContent = title;
            statusModalMessage.innerHTML = message;
            statusModalActions.innerHTML = buttonsHtml;
            statusModal.style.display = 'flex';
        }

        function hideStatusModal() {
            statusModal.style.display = 'none';
            if (addProductModal.style.display !== 'flex' && scannerModal.style.display !== 'flex') {
                searchBarEl.focus();
            }
        }

        function triggerPrintAndClose() {
            if (lastTransactionData.id && lastTransactionData.cart.length > 0) {
                printReceipt(lastTransactionData.id, lastTransactionData.cart);
            }
            hideStatusModal();
            resetAfterCheckout();
        }

        function closeAndReset() {
            hideStatusModal();
            resetAfterCheckout();
        }

        function resetAfterCheckout() {
            cart = [];
            updateCartSummary();
            loadProducts(); 
            lastTransactionData = { id: null, cart: [] };
        }

        function closeStatusModalOnError() {
             hideStatusModal();
            if (scannerModal.style.display !== 'flex') {
                 searchBarEl.focus();
             }
        }

        function updateLocalStockAndCache(cartItems) {
            console.log("Updating local stock and cache...");
            let productsUpdated = false;
            cartItems.forEach(item => {
                const productInAll = allProducts.find(p => p.id === item.id);
                if (productInAll) {
                    productInAll.stock -= item.quantity;
                    if (productInAll.stock < 0) {
                        productInAll.stock = 0;
                    }
                    productsUpdated = true;
                }
            });
            if (productsUpdated) {
                try {
                    const cacheData = {
                        timestamp: Date.now(),
                        data: allProducts
                    };
                    localStorage.setItem(CACHE_KEY, JSON.stringify(cacheData));
                    console.log("Cache localStorage diperbarui setelah checkout.");
                } catch (e) {
                    console.error("Gagal memperbarui localStorage:", e);
                    localStorage.removeItem(CACHE_KEY);
                }
            }
        }

        function loadCategories() {
            const uniqueCategories = [...new Set(allProducts.map(p => p.category))];
            const validUniqueCategories = uniqueCategories.filter(c => c && c.trim() !== '');
            categories = ['Semua', ...validUniqueCategories];

            categoryFilterEl.innerHTML = '';
            categories.forEach(category => {
                const button = document.createElement('button');
                button.innerText = category;
                button.setAttribute('data-category', category);
                if (category === 'Semua') {
                    button.className = 'active';
                }
                button.addEventListener('click', () => filterByCategory(category));
                categoryFilterEl.appendChild(button);
            });

            const realCategories = categories.filter(c => c !== 'Semua');
            categoryDatalist.innerHTML = '';
            realCategories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                categoryDatalist.appendChild(option);
            });
        }

        function loadProducts() {
            productListEl.innerHTML = '';
            let filteredProducts = allProducts;
            if (currentCategory !== 'Semua') {
                filteredProducts = filteredProducts.filter(p => p.category === currentCategory);
            }
            if (currentSearch) {
                filteredProducts = filteredProducts.filter(p =>
                    p.name.toLowerCase().includes(currentSearch) ||
                    (p.id && p.id.toString().toLowerCase().includes(currentSearch))
                );
            }

            productNotFoundEl.style.display = filteredProducts.length === 0 ? 'block' : 'none';
            const validProducts = filteredProducts.filter(p => p.id && p.name);

            validProducts.forEach(product => {
                const item = document.createElement('div');
                item.className = 'product-item';
                item.setAttribute('data-id', product.id);
                item.innerHTML = `
                    <h4>${product.name}</h4>
                    <div>
                        <p>${formatRupiah(product.price)}</p>
                        <span class="stock">Stok: ${product.stock}</span>
                    </div>
                `;
                if (product.stock === 0) {
                    item.style.opacity = '0.5';
                    item.style.cursor = 'not-allowed';
                } else {
                    item.addEventListener('click', () => addToCart(product.id));
                }
                productListEl.appendChild(item);
            });
        }

        function filterByCategory(category) {
            currentCategory = category;
            document.querySelectorAll('.category-filter button').forEach(btn => {
                btn.classList.toggle('active', btn.getAttribute('data-category') === category);
            });
            loadProducts();
        }

        function filterBySearch(searchTerm) {
            currentSearch = searchTerm.toLowerCase();
            loadProducts();
        }

        function addToCart(productId) {
            const product = allProducts.find(p => p.id === productId);
            if (!product) return;
            const existingItem = cart.find(item => item.id === productId);
            const currentStock = product.stock;
            const cartQuantity = existingItem ? existingItem.quantity : 0;
            if (cartQuantity >= currentStock) {
                const title = "Stok Tidak Cukup";
                const message = `Stok ${product.name} tidak mencukupi. Sisa stok: ${currentStock}`;
                const buttonsHtml = `<button class="modal-btn-primary" onclick="closeStatusModalOnError()" style="grid-column: 1 / -1;">Tutup</button>`;
                showStatusModal(title, message, buttonsHtml);
                return;
            }
            if (existingItem) {
                existingItem.quantity++;
            } else {
                cart.push({
                    id: product.id, name: product.name, price: product.price, quantity: 1
                });
            }
            updateCartSummary();
        }

        function decrementCartItem(productId) {
            const existingItem = cart.find(item => item.id === productId);
            if (!existingItem) return;
            existingItem.quantity--;
            if (existingItem.quantity === 0) {
                cart = cart.filter(item => item.id !== productId);
            }
            if (cart.length === 0) {
                hideCheckoutModal();
            }
        }

        function updateCartSummary() {
            let totalItems = 0;
            let totalPrice = 0;
            cart.forEach(item => {
                totalItems += item.quantity;
                totalPrice += item.price * item.quantity;
            });
            cartItemCountEl.textContent = `${totalItems} Item`;
            totalPriceEl.textContent = formatRupiah(totalPrice);
            const isEmpty = cart.length === 0;
            checkoutButton.disabled = isEmpty;
            resetCartButton.disabled = isEmpty;
        }

        function showCheckoutModal() {
            modalCartListEl.innerHTML = '';
            let totalPrice = 0;
            const sortedCart = [...cart].reverse();
            sortedCart.forEach(item => {
                const li = document.createElement('li');
                const itemTotal = item.price * item.quantity;
                const product = allProducts.find(p => p.id === item.id);
                const isStockMaxed = (product && item.quantity >= product.stock);
                li.innerHTML = `
                    <span class="item-name">${item.name}</span>
                    <div class="item-qty-controls">
                        <button class="modal-qty-btn modal-qty-minus" data-id="${item.id}">-</button>
                        <span>${item.quantity}</span>
                        <button class="modal-qty-btn modal-qty-plus" data-id="${item.id}" ${isStockMaxed ? 'disabled' : ''}>+</button>
                    </div>
                    <span class="item-total">${formatRupiah(itemTotal)}</span>
                `;
                modalCartListEl.appendChild(li);
                totalPrice += itemTotal;
            });
            modalTotalPriceEl.textContent = formatRupiah(totalPrice);
            if (cart.length > 0) {
                checkoutModal.style.display = 'flex';
            } else {
                hideCheckoutModal();
            }
        }

        function hideCheckoutModal() {
            checkoutModal.style.display = 'none';
            searchBarEl.focus(); 
        }

        async function processCheckout() {
            if (cart.length === 0) return;
            const cartToPrint = JSON.parse(JSON.stringify(cart));
            hideCheckoutModal();
            loadingOverlay.style.display = 'flex';
            loadingOverlay.textContent = 'Memproses...';

            try {
                const payload = cart; 
                const response = await fetch(GAS_URL, {
                    method: 'POST',
                    mode: 'cors',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify(payload),
                });
                const result = await response.json();

                if (result.status === "success") {
                    updateLocalStockAndCache(cartToPrint);
                    lastTransactionData.id = result.transactionId;
                    lastTransactionData.cart = cartToPrint;
                    const title = "Transaksi Berhasil!";
                    const message = `ID Transaksi: <strong>${result.transactionId}</strong><br>Apakah Anda ingin mencetak struk?`;
                    const buttonsHtml = `
                        <button class="modal-btn-secondary" onclick="closeAndReset()">Selesai (Tanpa Struk)</button>
                        <button class="modal-btn-primary" onclick="triggerPrintAndClose()">Cetak Struk</button>
                    `;
                    loadingOverlay.style.display = 'none';
                    showStatusModal(title, message, buttonsHtml);
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                console.error('Error saat checkout:', error);
                const title = "Transaksi Gagal";
                const message = `Terjadi kesalahan: ${error.message}. Silakan coba lagi.`;
                const buttonsHtml = `<button class="modal-btn-primary" onclick="closeStatusModalOnError()" style="grid-column: 1 / -1;">Tutup</button>`;
                loadingOverlay.style.display = 'none';
                showStatusModal(title, message, buttonsHtml);
            }
        }

        function resetCart() {
            if (cart.length === 0) return;
            const title = "Reset Keranjang";
            const message = "Apakah Anda yakin ingin mengosongkan keranjang?";
            const buttonsHtml = `
                <button class="modal-btn-secondary" onclick="hideStatusModal()">Batal</button>
                <button id="confirm-reset-button" class="modal-btn-primary" style="background-color:#dc3545;">Ya, Kosongkan</button>
            `;
            showStatusModal(title, message, buttonsHtml);
            document.getElementById('confirm-reset-button').addEventListener('click', () => {
                cart = [];
                updateCartSummary();
                hideStatusModal();
            }, { once: true });
        }

        async function fetchProducts(forceSync = false) {
            loadingOverlay.style.display = 'flex';
            loadingOverlay.textContent = forceSync ? 'Sinkronisasi Ulang...' : 'Memuat Produk...';

            if (forceSync) {
                localStorage.removeItem(CACHE_KEY);
                console.log("Cache produk dihapus (Sync Paksa).");
            } else {
                try {
                    const cachedItem = localStorage.getItem(CACHE_KEY);
                    if (cachedItem) {
                        const { timestamp, data } = JSON.parse(cachedItem);
                        if (Date.now() - timestamp < CACHE_EXPIRATION_MS) {
                            console.log("Memuat produk dari localStorage cache...");
                            allProducts = data;
                            loadCategories();
                            loadProducts();
                            loadingOverlay.style.display = 'none';
                            return;
                        } else {
                            console.log("Cache produk kadaluarsa.");
                            localStorage.removeItem(CACHE_KEY);
                        }
                    }
                } catch (e) {
                    console.error("Gagal membaca cache:", e);
                    localStorage.removeItem(CACHE_KEY);
                }
            }

            console.log("Fetching produk dari server...");
            let url = GAS_URL;
            if (forceSync) {
                url += "?action=clearCache";
            }

            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error('Gagal mengambil data produk dari server.');
                }
                const data = await response.json();
                allProducts = data;

                try {
                    const cacheData = {
                        timestamp: Date.now(),
                        data: allProducts
                    };
                    localStorage.setItem(CACHE_KEY, JSON.stringify(cacheData));
                    console.log("Produk disimpan ke localStorage cache.");
                } catch (e) {
                    console.error("Gagal menyimpan ke localStorage:", e);
                }

                loadCategories();
                loadProducts();
            } catch (error) {
                console.error('Error fetching products:', error);
                const title = "Gagal Memuat Produk";
                const message = `Gagal memuat produk. Cek koneksi atau URL Google Apps Script. (${error.message})`;
                const buttonsHtml = `<button class="modal-btn-primary" onclick="closeStatusModalOnError()" style="grid-column: 1 / -1;">Tutup</button>`;
                showStatusModal(title, message, buttonsHtml);
                productListEl.innerHTML = '<p>Gagal memuat produk.</p>';
            } finally {
                loadingOverlay.style.display = 'none';
            }
        }


        async function handleSaveProduct(e) {
            e.preventDefault();

            const productId = document.getElementById('new-product-id').value.trim();
            const productName = document.getElementById('new-product-name').value;
            const productPrice = parseFloat(document.getElementById('new-product-price').value);
            const productStock = parseInt(document.getElementById('new-product-stock').value);
            const productCategory = document.getElementById('new-product-category').value;

            if (!productId || !productName || !productCategory || isNaN(productPrice) || productPrice <= 0 || isNaN(productStock) || productStock < 0) {
                const title = "Input Tidak Valid";
                const message = "Pastikan Barcode (ID), Nama, Harga (angka positif), Stok (angka 0 atau lebih), dan Kategori sudah terisi dengan benar.";
                const buttonsHtml = `<button class="modal-btn-primary" onclick="closeStatusModalOnError()" style="grid-column: 1 / -1;">Tutup</button>`;
                showStatusModal(title, message, buttonsHtml);
                return;
            }

            const existingProduct = allProducts.find(p => p.id && p.id.toString().toLowerCase() === productId.toLowerCase());
            if (existingProduct) {
                const title = "ID Duplikat";
                const message = `Barcode/ID <strong>${productId}</strong> sudah digunakan untuk barang <strong>${existingProduct.name}</strong>. Silakan gunakan ID lain.`;
                const buttonsHtml = `<button class="modal-btn-primary" onclick="closeStatusModalOnError()" style="grid-column: 1 / -1;">Tutup</button>`;
                showStatusModal(title, message, buttonsHtml);
                return; 
            }

            addProductModal.style.display = 'none';
            loadingOverlay.style.display = 'flex';
            loadingOverlay.textContent = 'Menyimpan Barang...';

            const payload = {
                action: "addProduct",
                product: {
                    id: productId,
                    name: productName,
                    price: productPrice,
                    category: productCategory,
                    stock: productStock
                }
            };

            try {
                const response = await fetch(GAS_URL, {
                    method: 'POST',
                    mode: 'cors',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify(payload),
                });
                const result = await response.json();

                if (result.status === "success") {
                    loadingOverlay.style.display = 'none';

                    const title = "Berhasil!";
                    const message = `Barang <strong>${productName}</strong> (ID: ${result.newId}) berhasil ditambahkan.<br>Memuat ulang daftar produk...`;
                    const buttonsHtml = `<button id="close-success-add-btn" class="modal-btn-primary" style="grid-column: 1 / -1;">OK</button>`;
                    showStatusModal(title, message, buttonsHtml);

                    document.getElementById('close-success-add-btn').addEventListener('click', () => {
                        hideStatusModal();
                        fetchProducts(true); 
                    }, { once: true });

                    addProductForm.reset();

                } else {
                    throw new Error(result.message); 
                }

            } catch (error) {
                console.error('Error saat tambah produk:', error);
                loadingOverlay.style.display = 'none';

                const title = "Gagal Menyimpan";
                const message = `Terjadi kesalahan: ${error.message}. Silakan coba lagi.`;
                const buttonsHtml = `<button class="modal-btn-primary" onclick="closeStatusModalOnError()" style="grid-column: 1 / -1;">Tutup</button>`;
                showStatusModal(title, message, buttonsHtml);

                addProductModal.style.display = 'flex';
            }
        }

        // ==========================================================
        // === FUNGSI-FUNGSI BARU UNTUK QUAGGAJS SCANNER ===
        // ==========================================================

        function startQuaggaScanner(purpose) {
            scannerPurpose = purpose;
            scannerModal.style.display = 'flex';

            const quaggaConfig = {
                inputStream: {
                    name: "Live",
                    type: "LiveStream",
                    target: document.querySelector('#interactive'), // Targetkan div viewport
                    constraints: {
                         // Coba resolusi yang lebih umum atau hapus constraint ini
                         // width: { min: 640 }, 
                         // height: { min: 480 },
                        facingMode: "environment", 
                         aspectRatio: { min: 1, max: 2 } // Biarkan lebih fleksibel
                    },
                    area: { // Area pemrosesan (opsional, bisa mempercepat)
                        top: "20%",    // Mulai dari 20% dari atas
                        right: "10%",  // Sampai 10% dari kanan
                        left: "10%",   // Mulai 10% dari kiri
                        bottom: "20%"  // Sampai 20% dari bawah
                    },
                     singleChannel: false 
                },
                decoder: {
                     readers: [
                        "ean_reader", 
                        "ean_8_reader",
                        "code_128_reader", 
                        "upc_reader",
                        "upc_e_reader"
                    ],
                    debug: {
                         drawBoundingBox: true, // Tampilkan kotak di sekitar barcode yg terdeteksi
                         showFrequency: false,
                         drawScanline: true, // Tampilkan garis scan di hasil debug (jika ada canvas debug)
                         showPattern: false
                    },
                     multiple: false 
                },
                 locate: true, 
                numOfWorkers: navigator.hardwareConcurrency >= 4 ? 4 : navigator.hardwareConcurrency, // Batasi worker
                 frequency: 10, 
            };

            Quagga.init(quaggaConfig, function(err) {
                if (err) {
                    console.error("QuaggaJS init error:", err);
                    let message = `Gagal memulai scanner: ${err.message || err}`;
                     if (err.name === 'NotAllowedError') {
                         message = "Izin akses kamera ditolak. Mohon izinkan akses kamera pada browser.";
                     } else if (err.name === 'NotFoundError' || err.name === 'DevicesNotFoundError') {
                         message = "Kamera tidak ditemukan. Pastikan kamera terhubung dan tidak digunakan aplikasi lain.";
                    } else if (err.name === 'NotReadableError' || err.name === 'TrackStartError') {
                         message = "Kamera sedang digunakan oleh aplikasi lain atau terjadi error pada kamera.";
                     } else if (err.message && err.message.includes('enumerateDevices() not supported')) {
                         message = "Browser Anda tidak sepenuhnya mendukung akses kamera yang dibutuhkan. Coba browser lain atau update browser Anda.";
                     }
                    
                    showStatusModal("Scanner Error", message, `<button class="modal-btn-primary" onclick="closeStatusModalOnError()" style="grid-column: 1 / -1;">Tutup</button>`);
                    stopQuaggaScanner(); 
                    return;
                }
                console.log("QuaggaJS initialized successfully.");
                Quagga.start();
                isQuaggaRunning = true;
                console.log("QuaggaJS started.");
            });

             // --- Hapus listener lama dan tambahkan listener baru ---
            Quagga.offDetected(quaggaOnDetected); 
            Quagga.onDetected(quaggaOnDetected); 

             // Listener untuk menggambar box deteksi (jika debug: { drawBoundingBox: true })
             Quagga.onProcessed(function(result) {
                 var drawingCtx = Quagga.canvas.ctx.overlay,
                     drawingCanvas = Quagga.canvas.dom.overlay;

                 if (result) {
                    // Hapus gambar sebelumnya
                    drawingCtx.clearRect(0, 0, parseInt(drawingCanvas.getAttribute("width")), parseInt(drawingCanvas.getAttribute("height")));
                     if (result.boxes) {
                         result.boxes.filter(function (box) {
                             return box !== result.box;
                         }).forEach(function (box) {
                             Quagga.ImageDebug.drawPath(box, {x: 0, y: 1}, drawingCtx, {color: "green", lineWidth: 2});
                         });
                     }
                     // Gambar box utama jika ada hasil deteksi barcode
                     if (result.codeResult && result.codeResult.code) {
                         // Gambar box di sekitar barcode yang berhasil dideteksi
                         if (result.box) {
                              Quagga.ImageDebug.drawPath(result.box, {x: 0, y: 1}, drawingCtx, {color: "blue", lineWidth: 2});
                         }
                         // Gambar garis merah di tengah barcode (jika ada)
                         // if (result.line) {
                         //     Quagga.ImageDebug.drawPath(result.line, {x: 'x', y: 'y'}, drawingCtx, {color: 'red', lineWidth: 3});
                         // }
                     }
                 }
             });
        }

        function quaggaOnDetected(result) {
             // Tambahkan debounce sederhana untuk mencegah deteksi ganda terlalu cepat
            if (!isQuaggaRunning) return; // Jangan proses jika sudah distop

            if (!result || !result.codeResult || !result.codeResult.code) {
                 console.log("Deteksi tidak valid:", result);
                return;
            }

            const code = result.codeResult.code;
            console.log(`Barcode terdeteksi (${result.codeResult.format}): ${code}`);

            // Hentikan Quagga SEGERA setelah deteksi berhasil
            stopQuaggaScanner(); 

            // Proses kode yang terdeteksi
            if (scannerPurpose === 'sell') {
                const barcode = code.trim();
                const product = allProducts.find(p => p.id && p.id.toString().toLowerCase() === barcode.toLowerCase());

                if (product) {
                    addToCart(product.id);
                } else {
                    const title = "Barang Tidak Ditemukan";
                    const message = `Barang dengan barcode/ID <strong>${barcode}</strong> tidak ditemukan.`;
                    const buttonsHtml = `<button class="modal-btn-primary" onclick="closeStatusModalOnError()" style="grid-column: 1 / -1;">Tutup</button>`;
                    showStatusModal(title, message, buttonsHtml);
                }
            } else if (scannerPurpose === 'add') {
                document.getElementById('new-product-id').value = code;
                document.getElementById('new-product-name').focus();
            }

            scannerPurpose = null; 
             if (addProductModal.style.display !== 'flex') {
                 searchBarEl.focus();
             }
        }

        function stopQuaggaScanner() {
            if (isQuaggaRunning) {
                 Quagga.offDetected(quaggaOnDetected); 
                 Quagga.offProcessed(); // Hapus listener drawing box
                Quagga.stop();
                isQuaggaRunning = false;
                console.log("QuaggaJS stopped.");
                 // Hapus canvas overlay yang dibuat Quagga
                const overlayCanvas = document.querySelector('#interactive canvas.drawingBuffer');
                 if (overlayCanvas) {
                     overlayCanvas.remove();
                 }
                 const videoElement = document.querySelector('#interactive video');
                 if(videoElement) {
                      videoElement.remove(); // Hapus video juga
                 }
            }
            scannerModal.style.display = 'none'; 
            const interactiveElement = document.getElementById('interactive');
            if(interactiveElement) interactiveElement.innerHTML = ''; 

            scannerPurpose = null; 
             if (addProductModal.style.display !== 'flex') {
                 searchBarEl.focus();
             }
        }
        
        // --- Event Listeners (Update untuk Scanner) ---
        searchBarEl.addEventListener('input', (e) => filterBySearch(e.target.value));
        checkoutButton.addEventListener('click', showCheckoutModal);
        resetCartButton.addEventListener('click', resetCart);
        cancelPaymentButton.addEventListener('click', hideCheckoutModal);
        confirmPaymentButton.addEventListener('click', processCheckout);
        syncButton.addEventListener('click', () => {
            const title = "Sinkronisasi Ulang";
            const message = "Sinkronisasi ulang akan memuat data terbaru dari Google Sheet.<br>Lanjutkan?";
            const buttonsHtml = `
                <button class="modal-btn-secondary" onclick="hideStatusModal()">Batal</button>
                <button id="confirm-sync-button" class="modal-btn-primary">Lanjutkan</button>
            `;
            showStatusModal(title, message, buttonsHtml);
            document.getElementById('confirm-sync-button').addEventListener('click', () => {
                hideStatusModal();
                fetchProducts(true);
            }, { once: true });
        });

        modalCartListEl.addEventListener('click', (e) => {
            const target = e.target;
            if (target.classList.contains('modal-qty-plus')) {
                const id = target.dataset.id;
                addToCart(id);
                showCheckoutModal();
                updateCartSummary();
            }
            if (target.classList.contains('modal-qty-minus')) {
                const id = target.dataset.id;
                decrementCartItem(id);
                showCheckoutModal();
                updateCartSummary();
            }
        });

        addProductButton.addEventListener('click', () => {
            addProductModal.style.display = 'flex';
            document.getElementById('new-product-id').focus();
        });

        cancelAddProductButton.addEventListener('click', () => {
            addProductForm.reset();
            addProductModal.style.display = 'none';
            searchBarEl.focus(); 
        });

        addProductForm.addEventListener('submit', handleSaveProduct);

        // --- Event Listener untuk tombol scan (panggil fungsi Quagga) ---
        scanForSellButton.addEventListener('click', () => {
             startQuaggaScanner('sell');
        });

        scanForAddButton.addEventListener('click', () => {
             startQuaggaScanner('add');
        });

        cancelScanButton.addEventListener('click', () => {
             stopQuaggaScanner();
        });

        // --- Inisialisasi Aplikasi ---
        document.addEventListener('DOMContentLoaded', () => {
            fetchProducts();
            updateCartSummary();
            searchBarEl.focus(); 

            // --- KODE BARCODE SCANNING (USB/KEYBOARD) ---
            searchBarEl.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault(); 
                    const barcode = searchBarEl.value.trim();
                    if (barcode === "") return; 

                    const product = allProducts.find(p => p.id && p.id.toString().toLowerCase() === barcode.toLowerCase());

                    if (product) {
                        addToCart(product.id);
                        searchBarEl.value = ''; 
                        filterBySearch('');
                    } else {
                        const title = "Barang Tidak Ditemukan";
                        const message = `Barang dengan barcode/ID <strong>${barcode}</strong> tidak ditemukan.`;
                        const buttonsHtml = `<button class="modal-btn-primary" onclick="closeStatusModalOnError()" style="grid-column: 1 / -1;">Tutup</button>`;
                        showStatusModal(title, message, buttonsHtml);
                    }
                }
            });
            
        }); 
    </script>
</body>

</html>

